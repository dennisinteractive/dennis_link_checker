<?php
/**
 * @file
 */
use Dennis\Link\Checker\Processor;
use Dennis\Link\Checker\EntityHandler;
use Dennis\Link\Checker\Corrector;
use Dennis\Link\Checker\Stack as Queue;

/**
 * PSR-4 autoloader
 * files[] in .info doesn't find them.
 */
spl_autoload_register(function ($class) {
  if (strpos($class, 'Dennis\Link\Checker') === 0) {
    if (file_exists((__DIR__ . '/src/' . str_replace('\\', '/', $class) . '.php'))) {
      include(__DIR__ . '/src/' . str_replace('\\', '/', $class) . '.php');
    }
  }
});

/**
 * Run the link checker queue.
 */
function dennis_link_checker_run() {
  $site_host = parse_url(dennis_ga_get_live_url(), PHP_URL_HOST);
  $queue = new Queue('dennis_link_checker');
  $entity_handler = new EntityHandler();
  $entity_handler->setSiteHost($site_host);
  $corrector = new Corrector();
  $corrector->setSiteHost($site_host);
  $processor = new Processor($queue, $entity_handler, $corrector);
  //$processor->setTimeLimit(20); // temporarily low time limit.
  $processor->run();
}
