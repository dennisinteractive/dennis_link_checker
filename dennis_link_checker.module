<?php
/**
 * @file
 */

use Dennis\Link\Checker\Config;
use Dennis\Link\Checker\Logger;
use Dennis\Link\Checker\LinkLocalisation;
use Dennis\Link\Checker\Processor;
use Dennis\Link\Checker\EntityHandler;
use Dennis\Link\Checker\Analyzer;
use Dennis\Link\Checker\Throttler;
use Dennis\Link\Checker\Database;
use Dennis\Link\Checker\Queue;

/**
 * PSR-4 autoloader
 * files[] in .info doesn't find them.
 */
spl_autoload_register(function ($class) {
  if (strpos($class, 'Dennis\Link\Checker') === 0) {
    if (file_exists((__DIR__ . '/src/' . str_replace('\\', '/', $class) . '.php'))) {
      include(__DIR__ . '/src/' . str_replace('\\', '/', $class) . '.php');
    }
  }
});

/**
 * Setup the link processor.
 *
 * @param array $nids
 * @return \Dennis\Link\Checker\ProcessorInterface
 */
function dennis_link_checker_setup(array $nids) {
  $site_host = parse_url(dennis_ga_get_live_url(), PHP_URL_HOST);
  $config = (new Config())
    ->setLogger((new Logger())->setVerbosity(Logger::VERBOSITY_HIGH))
    ->setSiteHost($site_host)
    ->setMaxRedirects(10)
    ->setInternalOnly(TRUE)
    ->setLocalisation(LinkLocalisation::ORIGINAL)
    ->setNodeList($nids);

  $queue = new Queue('dennis_link_checker');
  $entity_handler = new EntityHandler($config);

  // Make sure we don't request more than one page per second.
  $curl_throttler = new Throttler(1);

  // Database object that allows interaction with the DB.
  $database = new Database();

  $analyzer = new Analyzer($config, $curl_throttler, $database);
  return new Processor($config, $queue, $entity_handler, $analyzer);
}

/**
 * Run the link checker queue.
 *
 * @param array $nids
 */
function dennis_link_checker_run(array $nids) {
  $processor = dennis_link_checker_setup($nids);
  //$processor->setTimeLimit(20); // temporarily low time limit.
  $processor->run();
}
